name: Deploy to Azure

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (e.g., v0.4.2, v1.0.0)
  workflow_dispatch:  # Allow manual trigger from GitHub UI
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  RESOURCE_GROUP: rg-ansvar-dev
  REGISTRY_NAME: ansvardev
  CONTAINER_ENV: cae-ansvar-dev
  MCP_APP: eu-regulations-mcp
  API_APP: eu-regulations-api
  DB_NAME: psql-ansvar-dev
  DB_ADMIN: ansvaradmin
  DB_DATABASE: eu_regulations

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Image Tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
          else
            IMAGE_TAG="$(date +%Y%m%d-%H%M%S)"
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Image tag: $IMAGE_TAG"

      - name: Get Database Password from Key Vault
        id: db-password
        run: |
          DB_PASSWORD=$(az keyvault secret show \
            --vault-name kv-ansvar-dev \
            --name postgres-password \
            --query value -o tsv)
          echo "::add-mask::$DB_PASSWORD"
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_OUTPUT
          echo "âœ… Retrieved database password from Key Vault"

      - name: Build Docker Image
        env:
          IMAGE_TAG: ${{ steps.image-tag.outputs.IMAGE_TAG }}
        run: |
          echo "ðŸ”¨ Building Docker image..."
          REGISTRY_SERVER=$(az acr show --name ${{ env.REGISTRY_NAME }} --query loginServer -o tsv)

          docker build \
            -t $REGISTRY_SERVER/eu-regulations:$IMAGE_TAG \
            -t $REGISTRY_SERVER/eu-regulations:latest \
            .

          echo "âœ… Built image: $REGISTRY_SERVER/eu-regulations:$IMAGE_TAG"

      - name: Push to Azure Container Registry
        env:
          IMAGE_TAG: ${{ steps.image-tag.outputs.IMAGE_TAG }}
        run: |
          echo "ðŸ“¤ Pushing to registry..."
          az acr login --name ${{ env.REGISTRY_NAME }}
          REGISTRY_SERVER=$(az acr show --name ${{ env.REGISTRY_NAME }} --query loginServer -o tsv)

          docker push $REGISTRY_SERVER/eu-regulations:$IMAGE_TAG
          docker push $REGISTRY_SERVER/eu-regulations:latest

          echo "âœ… Pushed to $REGISTRY_SERVER"

      - name: Deploy MCP Server
        env:
          DB_PASSWORD: ${{ steps.db-password.outputs.DB_PASSWORD }}
        run: |
          echo "ðŸš€ Deploying MCP Server..."
          REGISTRY_SERVER=$(az acr show --name ${{ env.REGISTRY_NAME }} --query loginServer -o tsv)
          DB_CONNECTION_STRING="postgresql://${{ env.DB_ADMIN }}:$DB_PASSWORD@${{ env.DB_NAME }}.postgres.database.azure.com:5432/${{ env.DB_DATABASE }}?sslmode=require"

          az containerapp update \
            --name ${{ env.MCP_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image $REGISTRY_SERVER/eu-regulations:latest \
            --set-env-vars \
              NODE_ENV=production \
              MCP_HTTP_PORT=3000 \
              PORT=3000 \
              DATABASE_URL="$DB_CONNECTION_STRING" \
            --output none

          MCP_URL=$(az containerapp show \
            --name ${{ env.MCP_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "âœ… MCP Server deployed: https://$MCP_URL"
          echo "MCP_URL=$MCP_URL" >> $GITHUB_ENV

      - name: Deploy REST API
        env:
          DB_PASSWORD: ${{ steps.db-password.outputs.DB_PASSWORD }}
        run: |
          echo "ðŸŒ Deploying REST API..."
          REGISTRY_SERVER=$(az acr show --name ${{ env.REGISTRY_NAME }} --query loginServer -o tsv)
          DB_CONNECTION_STRING="postgresql://${{ env.DB_ADMIN }}:$DB_PASSWORD@${{ env.DB_NAME }}.postgres.database.azure.com:5432/${{ env.DB_DATABASE }}?sslmode=require"

          az containerapp update \
            --name ${{ env.API_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image $REGISTRY_SERVER/eu-regulations:latest \
            --set-env-vars \
              NODE_ENV=production \
              SERVICE_TYPE=api \
              PORT=3001 \
              DATABASE_URL="$DB_CONNECTION_STRING" \
              SKIP_AUTH=true \
              SKIP_RATE_LIMIT=true \
            --output none

          API_URL=$(az containerapp show \
            --name ${{ env.API_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "âœ… REST API deployed: https://$API_URL"
          echo "API_URL=$API_URL" >> $GITHUB_ENV

      - name: Test Deployments
        run: |
          echo "ðŸ” Testing deployments..."

          # Give containers time to start (cold start)
          sleep 10

          # Test MCP Server
          echo "Testing MCP Server health..."
          MCP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.MCP_URL }}/health || echo "000")

          if [ "$MCP_STATUS" = "200" ]; then
            echo "âœ… MCP Server healthy (HTTP $MCP_STATUS)"
          else
            echo "âš ï¸  MCP Server returned HTTP $MCP_STATUS (may be cold starting)"
          fi

          # Test REST API
          echo "Testing REST API health..."
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.API_URL }}/health || echo "000")

          if [ "$API_STATUS" = "200" ]; then
            echo "âœ… REST API healthy (HTTP $API_STATUS)"
          else
            echo "âš ï¸  REST API returned HTTP $API_STATUS (may be cold starting)"
          fi

      - name: Deployment Summary
        run: |
          echo "==========================================" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "==========================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ steps.image-tag.outputs.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Service URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **MCP Server** | https://${{ env.MCP_URL }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **REST API** | https://${{ env.API_URL }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Test Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# MCP Health Check" >> $GITHUB_STEP_SUMMARY
          echo "curl https://${{ env.MCP_URL }}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# REST API Search" >> $GITHUB_STEP_SUMMARY
          echo 'curl -X POST https://${{ env.API_URL }}/api/search \' >> $GITHUB_STEP_SUMMARY
          echo "  -H 'Content-Type: application/json' \\" >> $GITHUB_STEP_SUMMARY
          echo '  -d '"'"'{"query":"DORA","limit":3}'"'"'' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** First requests may take 2-3 seconds (cold start with scale-to-zero)" >> $GITHUB_STEP_SUMMARY
